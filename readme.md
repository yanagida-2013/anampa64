# MPA3のリストファイル
MPA3に限らず、ADCの出力はバイナリデータです。
バイナリデータはアスキーデータと異なり、一般的に解読が難しいです。
きちんと説明書を読みましょう。

[FAST MPA-3 user's manual](http://www3.nd.edu/~wzech/mpa3doc.pdf)

# バイナリファイルとは
MPA3のリストファイルの構造を理解するにはバイナリデータについて知る必要があります。
ASCIIデータは文字が並んでいるのに対して、バイナリデータは0と1が連続して2進数のように書き込まれています。0or1はビットと呼ばれています。
音楽ファイルの音質を表す時に128kbpsなどが使われていますが、１秒あたり128000ビット分のデータが音を表現するのに使われているという意味です。
ビットの上位単位にはバイトがあり、1バイトは8ビットです。
一般的にバイナリデータを人間が読む際には16進数が使われます。16進数はその数が16真数であることを示すために、始めに「0x」が付きます。
例：
100  -> 0x0064
1000 -> 0x03e8
コンピュータ上では16進数は0,1,..9,a,b,c,d,e,fと表記されます。
「全てがFになる」という小説がありますね。映画化されるみたいですね。

#  リストファイルの構造
リストファイルは大きく分けて２つの構造に分けられます。
- ascii形式のヘッダー
- binary形式のデータ
前者には計測の条件などが書き込まれています。
後者には実際の計測データが書き込まれています。

前者について説明する必要はないと思うので、後者について説明していきます。

# バイナリ形式のデータの構造
バイナリデータは4バイトが一つの単位になって書き込まれています。
2バイトはさらに2つにわかれ、2バイトと2バイトのペアになって構成されています。
2バイトは16ビットなので、16進数に変換すると、4文字になります（わかりますか？）。
16進数1文字は16種類、すなわち2の4乗で4bit分のデータを持つためです。

4バイトの文字を読み込んだ時、前半の2バイトに現れる可能性のあるデータは以下の通りです:
- タイムタグ : 0x4000
- シンクロナイズタグ : 0xffff
- データタグ : 0x0000, 0x8000
- PH,TOFなどの数値データ

## タイムタグ
基本設定でADCは1[msec]ごとにリストデータにタイムタグを挿入します。
タイムタグの前半2バイトは絶対に0x4000です。
後半は複数のADCがある際の生死を表示します。1なら生存、0なら死亡です。
最後の桁がADC1、最後から２つ目がADC2といった具合です。
- 0xffff : 1111111111111111 => ADC1,2ともに生存。
- 0xfffe : 1111111111111110 => ADC2のみ生存。
- 0xfffd : 1111111111111101 => ADC1のみ生存。
- 0xfffc : 1111111111111100 => ADC1,2ともに死亡。

## シンクロナイズタグ
シンクロナイズタグの後にはデータタグが続きます。
シンクロナイズタグの前半は0xffffで、後半も0xffffです。

## データタグ
データタグはその後に続く数値データの情報を表示します。
前半についてはマニュアルに詳しい説明はありませんでしたが、上から3つめのビットは確実に0になっています。
調べてわかったことですが、後ろに数値データが２つならぶ場合は0x0000、１つの場合は0x8000でした。
後半については、続く数値データを出すADCについての情報が書かれています。
タイムタグと同様な表記方法で、数値データを出すならば1、出さないならば0となっています。
ペレトロンの実験ならばPHとTOFで2つとなっていることが多いでしょう。
つまり、通常ならば後半は0x0003（0000000000000011）となっています。

データタグの後ろには数値データが続きます。

## 数値データ
偶数個の数値データの場合は2バイトのデータがそれぞれのADCから記録されます。
例：ADCが4つある場合
(ADC1, ADC2), (ADC3, ADC4)
奇数個の数値データがある場合は最後にダミーデータが記録されます。
例：ADCが3つある場合
(ADC1, ADC2), (ADC3, dummy)


# MPA3リストファイルを処理するプログラム
## gatempa用にPH-TOFのバイナリデータのみを取り出して書き出すプログラム。
- anampa.c : igatool内にある。32bit用。コンパイルでWarningがいっぱい出るかもしれないけど問題ない。
- anampa_64.c : 64bit用に書き換え、Warningが出ないように書き換えた。
- readList.cpp : MPAリストファイル学習用C++プログラム

## ゲインシフトなどがRunの最中に起きた際に時間スケールでスペクトルを吐き出すプログラム
- shiftDetector.cpp : ヒストグラムごとにファイルを吐き出す。あとの編集に便利。gnuplotがインストールされていれば、gifアニメーションも作る。
- shiftDetector2.cpp : ファイルを１つ書き出す。スマート。gnuplotがインストールされていれば、gifアニメーションも作る。
- shiftDetector3.cpp : ADCが１つしかない時専用。gifアニメーションを書き出す。
- shiftDetector4.cpp : ADCが１つしかない時専用。gnuplotのpm3dグラフのインプットを書き出す。



